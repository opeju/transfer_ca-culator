# ============================================================================
# Configuração Apache - Calculadora de Transfer
# ============================================================================
# Copie este arquivo para /etc/apache2/sites-available/transfer_calculator.conf
# Depois habilite com: sudo a2ensite transfer_calculator

# Redirecionar HTTP para HTTPS
<VirtualHost *:80>
    ServerName seu-dominio.com
    ServerAlias www.seu-dominio.com

    # Permitir renovação de certificado Let's Encrypt
    DocumentRoot /var/www/certbot

    <Directory /var/www/certbot>
        Require all granted
    </Directory>

    # Redirecionar tudo para HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

# Servidor HTTPS principal
<VirtualHost *:443>
    ServerName seu-dominio.com
    ServerAlias www.seu-dominio.com

    # ========================================================================
    # Certificados SSL (Let's Encrypt)
    # ========================================================================
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/seu-dominio.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/seu-dominio.com/privkey.pem

    # Configurações SSL modernas
    SSLProtocol TLSv1.2 TLSv1.3
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on

    # HSTS
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # ========================================================================
    # Headers de Segurança
    # ========================================================================
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'"

    # ========================================================================
    # Configurações Gerais
    # ========================================================================
    DocumentRoot /var/www/transfer_calculator/dist/public
    ServerAdmin admin@seu-dominio.com

    # Logs
    ErrorLog /var/log/apache2/transfer_calculator_error.log
    CustomLog /var/log/apache2/transfer_calculator_access.log combined

    # ========================================================================
    # Compressão GZIP
    # ========================================================================
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css
        AddOutputFilterByType DEFLATE text/javascript application/javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>

    # ========================================================================
    # Cache para Arquivos Estáticos
    # ========================================================================
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # ========================================================================
    # Rewrite Rules (SPA)
    # ========================================================================
    <Directory /var/www/transfer_calculator/dist/public>
        Options -MultiViews
        RewriteEngine On
        
        # Não reescrever se for arquivo ou diretório existente
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        
        # Redirecionar para index.html
        RewriteRule ^ index.html [QSA,L]
        
        # Permitir acesso
        Require all granted
    </Directory>

    # ========================================================================
    # Proxy para Node.js (se necessário)
    # ========================================================================
    # Descomente se quiser usar proxy reverso
    # <IfModule mod_proxy.c>
    #     ProxyPreserveHost On
    #     ProxyPass / http://localhost:3000/
    #     ProxyPassReverse / http://localhost:3000/
    # </IfModule>

    # ========================================================================
    # Negar acesso a arquivos sensíveis
    # ========================================================================
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    <FilesMatch "~$">
        Require all denied
    </FilesMatch>

    # ========================================================================
    # Tamanho máximo de upload
    # ========================================================================
    LimitRequestBody 10485760

</VirtualHost>

# ============================================================================
# Configurações Globais (adicione ao apache2.conf ou mods-enabled)
# ============================================================================

# Habilitar módulos necessários:
# sudo a2enmod rewrite
# sudo a2enmod proxy
# sudo a2enmod proxy_http
# sudo a2enmod ssl
# sudo a2enmod headers
# sudo a2enmod deflate

